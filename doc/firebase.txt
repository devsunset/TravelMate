# Firebase 연동 상세 가이드

이 문서는 TravelMate 프로젝트(Flutter 앱, Node.js 백엔드)를 Firebase에 연동하는 전체 과정을 안내합니다.

---

## 목차

1.  **Firebase 프로젝트 설정 (웹 콘솔)**
    *   1.1. 신규 Firebase 프로젝트 생성
    *   1.2. Flutter 앱 등록 (Android & iOS)
    *   1.3. Firestore 데이터베이스 활성화
    *   1.4. Firebase 인증 활성화
    *   1.5. Node.js 백엔드용 서비스 계정 생성

2.  **Flutter 앱 (travel_mate_app) 연동**
    *   2.1. Firebase 관련 패키지 설치
    *   2.2. FlutterFire CLI 설치 및 설정
    *   2.3. Android 설정
    *   2.4. iOS 설정
    *   2.5. main.dart 파일 수정

3.  **Node.js 백엔드 (travel_mate_backend) 연동**
    *   3.1. `firebase-admin` 패키지 설치
    *   3.2. 서비스 계정 키 파일 추가 (보안 주의)
    *   3.3. 환경 변수 설정
    *   3.4. `app.js` 파일 수정

---

### 1. Firebase 프로젝트 설정 (웹 콘솔)

#### 1.1. 신규 Firebase 프로젝트 생성
1.  [Firebase 콘솔](https://console.firebase.google.com/)로 이동하여 Google 계정으로 로그인합니다.
2.  `프로젝트 추가`를 클릭하고, 프로젝트 이름을 `TravelMate` (또는 원하는 이름)으로 지정합니다.
3.  Google 애널리틱스 사용 여부를 선택하고(권장) 프로젝트 만들기를 완료합니다.

#### 1.2. Flutter 앱 등록 (Android, iOS, Web)
-   **중요**: 이 단계는 2.2 항목의 `flutterfire configure` 명령어로 자동화하는 것을 강력히 권장합니다.
-   만약 수동으로 진행한다면 아래 절차를 따릅니다.
    1.  프로젝트 개요 페이지에서 플랫폼 아이콘 (`Apple`, `Android`, `</>`)을 클릭하여 앱 등록을 시작합니다.
    2.  **Android 등록**:
        *   Android 패키지 이름: `travel_mate_app/android/app/build.gradle.kts` 파일 내 `applicationId` 값을 확인하여 입력합니다. (예: `com.example.travel_mate_app`)
        *   `앱 등록`을 클릭하고 `google-services.json` 파일을 다운로드합니다.
    3.  **iOS 등록**:
        *   iOS 번들 ID: Xcode에서 `Runner` -> `TARGETS` -> `Runner` -> `General` -> `Identity`의 `Bundle Identifier` 값을 확인하여 입력합니다. (예: `com.example.travelMateApp`)
        *   `앱 등록`을 클릭하고 `GoogleService-Info.plist` 파일을 다운로드합니다.
    4.  **Web 등록**:
        *   `</>` 아이콘을 클릭합니다.
        *   `앱 닉네임`을 입력하고 `앱 등록`을 클릭합니다.
        *   `Firebase SDK 추가` 부분에 보이는 `firebaseConfig` 변수 코드를 복사해둡니다. (참고용. `flutterfire configure`가 이 과정을 대신합니다.)

#### 1.3. Firestore 데이터베이스 활성화
1.  Firebase 콘솔 왼쪽 메뉴에서 `빌드` > `Firestore Database`로 이동합니다.
2.  `데이터베이스 만들기`를 클릭합니다.
3.  `프로덕션 모드에서 시작`을 선택하고 `다음`을 누릅니다.
4.  Cloud Firestore 위치를 선택합니다. (보통 `asia-northeast3` (서울) 선택)
5.  `사용 설정`을 클릭합니다.

#### 1.4. Firebase 인증 활성화
1.  Firebase 콘솔 왼쪽 메뉴에서 `빌드` > `Authentication`으로 이동합니다.
2.  `시작하기`를 클릭합니다.
3.  `로그인 방법` 탭에서 원하는 인증 방식(예: `이메일/비밀번호`, `Google`)을 선택하고 활성화합니다.

#### 1.5. Node.js 백엔드용 서비스 계정 생성
1.  Firebase 콘솔 좌측 상단의 톱니바퀴 아이콘 > `프로젝트 설정`으로 이동합니다.
2.  `서비스 계정` 탭을 선택합니다.
3.  `새 비공개 키 생성` 버튼을 클릭하여 `.json` 형식의 키 파일을 다운로드합니다.
4.  **[매우 중요]** 이 파일은 백엔드에서 모든 Firebase 리소스에 접근할 수 있는 관리자 권한을 가집니다. **절대로 Git에 커밋하거나 외부에 노출해서는 안 됩니다.**

---

### 2. Flutter 앱 (travel_mate_app) 연동

#### 2.1. Firebase 관련 패키지 설치
1.  `travel_mate_app/pubspec.yaml` 파일을 엽니다.
2.  `dependencies:` 섹션에 아래 패키지들이 있는지 확인하고, 없다면 추가합니다.
    ```yaml
    dependencies:
      flutter:
        sdk: flutter
      firebase_core: ^3.1.1 # Firebase 초기화
      firebase_auth: ^5.1.1 # Firebase 인증
      cloud_firestore: ^5.0.2 # Firestore DB
      # 기타 필요한 firebase 패키지들...
    ```
3.  터미널에서 `travel_mate_app` 폴더로 이동 후 `flutter pub get` 명령어를 실행합니다.

#### 2.2. FlutterFire CLI 설치 및 설정 (권장 방식)
-   이 CLI 도구는 Flutter 프로젝트에 Android, iOS, Web 플랫폼의 Firebase 설정을 자동으로 구성해주는 가장 편리하고 정확한 방법입니다.

1.  **CLI 설치**:
    ```bash
    dart pub global activate flutterfire_cli
    ```
2.  **Firebase 로그인**:
    ```bash
    firebase login
    ```
3.  **Flutter 앱 구성**: `travel_mate_app` 디렉토리에서 아래 명령어를 실행합니다.
    ```bash
    flutterfire configure
    ```
    *   명령어를 실행하면 생성한 Firebase 프로젝트 목록이 나타납니다. `TravelMate` 프로젝트를 선택합니다.
    *   플랫폼을 선택하라는 메시지가 나타나면 키보드 화살표와 스페이스바를 사용하여 `android`, `ios`, `web`을 모두 선택하고 엔터를 누릅니다.
    *   이 과정이 완료되면 `lib/firebase_options.dart` 파일이 생성되고, 각 플랫폼별 설정 파일(`google-services.json`, `GoogleService-Info.plist` 등)이 자동으로 다운로드 및 배치됩니다. Web 설정은 `firebase_options.dart` 파일에 포함됩니다.

#### 2.3. Android 설정
-   `flutterfire configure`를 사용했다면 대부분 자동으로 완료됩니다.
-   `travel_mate_app/android/app/google-services.json` 파일이 있는지 확인합니다.
-   `travel_mate_app/android/app/build.gradle.kts` 파일에 google-services 플러그인이 적용되었는지 확인합니다.
    ```kotlin
    // 최상단에 추가
    plugins {
        // ...
        id("com.google.gms.google-services")
    }
    ```

#### 2.4. iOS 설정
-   `flutterfire configure`를 사용했다면 대부분 자동으로 완료됩니다.
-   `travel_mate_app/ios/Runner/GoogleService-Info.plist` 파일이 있는지 확인합니다.

#### 2.5. main.dart 파일 수정
-   앱이 시작될 때 Firebase를 초기화하도록 `lib/main.dart` 파일을 수정합니다.

```dart
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // flutterfire configure로 생성된 파일
import 'app/app.dart'; // 기존 앱 진입점

void main() async {
  // Flutter 엔진과 위젯 바인딩을 초기화합니다.
  WidgetsFlutterBinding.ensureInitialized();

  // Firebase를 초기화합니다.
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // 앱을 실행합니다.
  runApp(const MyApp()); // MyApp()은 기존 앱의 루트 위젯입니다.
}
```

---

### 3. Node.js 백엔드 (travel_mate_backend) 연동

#### 3.1. `firebase-admin` 패키지 설치
1.  터미널에서 `travel_mate_backend` 폴더로 이동합니다.
2.  아래 명령어를 실행하여 `firebase-admin` 패키지를 설치합니다.
    ```bash
    npm install firebase-admin dotenv
    ```
    (`dotenv`는 환경 변수를 쉽게 사용하기 위해 함께 설치합니다)

#### 3.2. 서비스 계정 키 파일 추가 (보안 주의)
1.  `1.5` 항목에서 다운로드한 `.json` 서비스 계정 키 파일의 이름을 `serviceAccountKey.json` (또는 원하는 이름)으로 변경합니다.
2.  이 파일을 `travel_mate_backend` 폴더 내에 위치시킵니다.
3.  **[매우 중요]** `travel_mate_backend/.gitignore` 파일을 열고, 아래 내용을 추가하여 키 파일이 Git에 커밋되지 않도록 합니다.
    ```
    # Firebase service account key
    serviceAccountKey.json

    # Environment variables
    .env
    ```

#### 3.3. 환경 변수 설정
1.  `travel_mate_backend` 폴더에 `.env` 파일을 생성합니다.
2.  `.env` 파일에 서비스 계정 키 파일의 경로를 지정하는 환경 변수를 추가합니다.
    ```
    GOOGLE_APPLICATION_CREDENTIALS="./serviceAccountKey.json"
    ```
    (경로는 `.env` 파일 위치 기준입니다)

#### 3.4. `app.js` 파일 수정
-   `travel_mate_backend/src/app.js` 파일의 상단에 Firebase Admin SDK 초기화 코드를 추가합니다.

```javascript
// travel_mate_backend/src/app.js

// .env 파일의 환경 변수를 로드합니다.
require('dotenv').config();

const express = require('express');
const admin = require('firebase-admin');

// --- Firebase Admin SDK 초기화 시작 ---
try {
  // GOOGLE_APPLICATION_CREDENTIALS 환경 변수에 지정된 경로의 키 파일로 초기화
  admin.initializeApp({
    credential: admin.credential.applicationDefault(),
  });
  console.log('Firebase Admin SDK C초기화 성공');
} catch (error) {
  console.error('Firebase Admin SDK 초기화 실패:', error);
  process.exit(1);
}
// --- Firebase Admin SDK 초기화 종료 ---

const app = express();

// ... 기존 app.js 코드 (미들웨어, 라우터 설정 등) ...

// 예시: 아래와 같이 다른 컨트롤러나 서비스에서 admin SDK를 사용할 수 있습니다.
// const db = admin.firestore();
// const auth = admin.auth();

module.exports = app;

```

이제 Flutter 앱과 Node.js 백엔드 모두 Firebase와 통신할 준비가 완료되었습니다. 각 애플리케이션을 다시 시작하여 변경 사항을 적용하세요.
